<HTML>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css">
		<script src = "http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
		<script src="tree_test.js"></script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script>
			function readTextFile(file){
				var allText = "";
				var rawFile = new XMLHttpRequest();
				rawFile.open("GET", file, false);
				rawFile.onreadystatechange = function () {
					if(rawFile.readyState === 4) {
						if(rawFile.status === 200 || rawFile.status == 0) {
							allText = rawFile.responseText;
						}
					}
				}
				rawFile.send(null);
				return allText;
			}
			
			function XMLToArray(text) {
				var head = '';
				var currentString ='';
				var ifCurrentStringIsHead = false;
				var ifCurrentStringIsComment = false;
				var ifCurrentStringIsTag = false;
				var newTag = new Object();
				var tagArray = [];
				var tagStack = [];
				var id = 0;
				for (var i=0; i<text.length; i++) {  // for all symbols in the text
					if (text[i] == '<' && !ifCurrentStringIsComment) {  // if we found an open tag and we are not writing a comment at the moment
						if (text[i+1] == '?') {  // if that's a headline
							ifCurrentStringIsHead = true;
						} else if (text[i+1] == '!' && text[i+2] == '-' && text[i+3] == '-') {  // if that's an end of a comment
							ifCurrentStringIsComment = true;
						} else {
							if (tagStack.length) {
								tagArray[tagStack[tagStack.length-1].id-1].value = currentString;  // add the information that's outside tags
								currentString = '';
							}
							ifCurrentStringIsTag = true;  // start the next tag
						}
					} else if (text[i] == '>') {  // if we found a close tag
						if (ifCurrentStringIsHead) {  // if we are writing a headline
							if (text[i-1] == '?') {
								ifCurrentStringIsHead = false;
							} else {
								//
							}
						} else if (ifCurrentStringIsComment) {  // if we are writing a comment
							if (text[i-1] == '-' && text[i-2] == '-') {  // and that's the end of the comment
								ifCurrentStringIsComment = false;
							}
						} else if (ifCurrentStringIsTag) {  // if we are writing the information that's inside tags
							if (text[i-1] == '/') {
								newTag.tag = currentString.substring(0, currentString.length-1);
								currentString = '';
								id += 1;
								newTag.id = id;
								newTag.children = [];
								if (tagStack.length) {
									newTag.parent = tagStack[tagStack.length-1].id;
									tagArray[tagStack[tagStack.length-1].id-1].children.push(newTag.id);
								} else {
									newTag.parent = 0;
								}
								tagArray.push(newTag);
							} else {
								if (currentString[0] == '/') {
									currentString = '';
									tagStack.pop();
								} else {
									newTag.tag = currentString;
									currentString = '';
									id += 1;
									newTag.id = id;
									newTag.children = [];
									if (tagStack.length) {
										newTag.parent = tagStack[tagStack.length-1].id;
										tagArray[tagStack[tagStack.length-1].id-1].children.push(newTag.id);
									} else {
										newTag.parent = 0;
									}
									tagArray.push(newTag);
									tagStack.push(newTag);
								}
							}
							ifCurrentStringIsTag = false;
							newTag={};
						}
					} else if (ifCurrentStringIsHead) {
						if (text[i] !== '?' && !(text[i] == '?' && text[i+1] == '>') && !(text[i] == '?' && text[i-1] == '<')) {
							head += text[i];
						} else {
							//
						}
					} else if (ifCurrentStringIsComment) {
						//
					} else if (ifCurrentStringIsTag) {
						currentString += text[i];
					} else {
						if (text[i] !== '\n' && text[i] != '\r' && text[i] != '\t') {
							currentString += text[i];
						} else {
							//
						}
					}
				}
				if (tagStack.length) {
					alert("XML file is not correct!");
				}
				return tagArray;
			}
			
			function ArrayToJSON(tagArray) {
				JSONText = [];
				var root = new Object();
				root = ObjToJSON(tagArray, 0, false);
				JSONText.push(root);
				return JSONText
			}
			
			function ObjToJSON(tagArray, id, parent) {
				var node = new Object();
				node.name = tagArray[id].tag;
				if (parent == false) {
					node.parent = "null"
				} else {
					node.parent = parent.name;
				}
				node.children = [];
				for (var i=0; i<tagArray[id].children.length; i++) {
					node.children.push(ObjToJSON(tagArray, tagArray[id].children[i]-1, node));
				}
				return node
			}
		</script>
		<script>
			var XMLText = readTextFile("http://maltse4n.bget.ru/II4dot0S/ExampleTopology.xml");
			var tagArray = XMLToArray(XMLText);
			var JSONText = ArrayToJSON(tagArray);
		</script>
	</head>
	<body>
		<div class="chart1"></div>
		<script type="text/javascript">
			drawTree("Drawing1", ".chart1", JSONText);
		</script>	
	</body>
</HTML>